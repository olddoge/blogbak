window.Tulips=(function(){var Tulip=function(){this.mainEle;this.row=3;this.column=3;this.zeroIndex=8;this.arr;this.initArr;this.imgW;this.imgH;this.unitW;this.unitH;this.imgSrc;this.startX;this.startY;this.needJudgeSuc=false;this.slideEvent=false;this.showImg=false;this.sucRemove=false;};Tulip.prototype={init:function(config){this.success=config.success;this.slideEvent=config.slideEvent?true:false;this.showImg=config.showImg?true:false;this.sucRemove=config.sucRemove?true:false;this.row=config.row?config.row:this.row;this.column=config.column?config.column:this.column;this.arr=[];for(var i=1;i<this.row*this.column;i++){this.arr.push(i);}
this.arr.push(0);this.initArr=this.arr.concat();this.zeroIndex=this.row*this.column-1;var that=this;this.imgElement=config.imgElement;　　if(this.imgElement.complete){this.initOperation();　　}
else{this.imgElement.onload=function(){that.initOperation();　　}　　}},initOperation:function(){this.imgW=this.imgElement.width;this.imgH=this.imgElement.height;if(!this.showImg){this.imgElement.style.display='none';}
this.imgSrc=this.imgElement.src;this.unitW=Math.floor(this.imgW/this.column);this.unitH=Math.floor(this.imgH/this.row);this.mainEle=document.createElement('div');this.mainEle.style.width=this.imgW+'px';this.mainEle.style.height=this.imgH+'px';this.mainEle.style['box-shadow']='0 0 3px #88309e';this.insertAfter(this.mainEle,this.imgElement);var htmlStr='';var index=0;for(var i=0;i<this.row;i++){for(var j=0;j<this.column;j++){var w=j*this.unitW;var h=i*this.unitH;if(index+1==this.arr.length){htmlStr+="<span id='item_"+index+"' style=\"background-image:url('"+this.imgSrc+"');background-position:-"
+w+"px -"+h+"px;width:"+(this.unitW-2)+"px;height:"+(this.unitH-2)+"px;background-size:"
+this.imgW+"px "+this.imgH+"px;top:0px;left:0px;opacity: 0;background-repeat: no-repeat;float: left;position: relative;transition-duration: 0.4s;-moz-transition-duration: 0.4s;-webkit-transition-duration: 0.4s;-o-transition-duration: 0.4s;border-radius: 4px 4px;border: 1px #ecbcf9 solid;\"></span>";}else{htmlStr+="<span id='item_"+index+"' style=\"background-image:url('"+this.imgSrc+"');background-position:-"
+w+"px -"+h+"px;width:"+(this.unitW-2)+"px;height:"+(this.unitH-2)+"px;background-size:"
+this.imgW+"px "+this.imgH+"px;top:0px;left:0px;background-repeat: no-repeat;float: left;position: relative;transition-duration: 0.4s;-moz-transition-duration: 0.4s;-webkit-transition-duration: 0.4s;-o-transition-duration: 0.4s;border-radius: 4px 4px;border: 1px #ecbcf9 solid;\"></span>";}
index++;}}
this.mainEle.innerHTML=htmlStr;this.randomSteps();this.needJudgeSuc=true;this.bindClickEvent();if(this.slideEvent)
this.bindSlideEvent();},insertAfter:function(newElement,targetElement){var parent=targetElement.parentNode;if(parent.lastChild==targetElement){parent.appendChild(newElement);}else{parent.insertBefore(newElement,targetElement.nextSibling);}},randomSteps:function(){var times=this.row*this.column*5;var that=this;var count=0;var rdInt=setInterval(function(){var direct;while(true){direct=parseInt(Math.random()*4+1,10);if(1===direct&&that.left())
break;else if(2===direct&&that.right())
break;else if(3===direct&&that.down())
break;else if(4===direct&&that.up())
break;}
if(times===count++)
clearInterval(rdInt);},10);},bindSlideEvent:function(){var that=this;that.mainEle.addEventListener('touchstart',function(e){e.preventDefault();var touch=e.touches[0];that.startX=touch.clientX;that.startY=touch.clientY;});that.mainEle.addEventListener('mousedown',function(e){e.preventDefault();that.startX=e.clientX;that.startY=e.clientY;});that.mainEle.addEventListener('touchend',function(e){e.preventDefault();var touch=e.changedTouches[0];var endX=touch.clientX;var endY=touch.clientY;that.judgeAction(endX-that.startX,endY-that.startY);});that.mainEle.addEventListener('mouseup',function(e){e.preventDefault();var endX=e.clientX;var endY=e.clientY;that.judgeAction(endX-that.startX,endY-that.startY);});},bindClickEvent:function(){var that=this;var childs=that.mainEle.childNodes;for(var i=0;i<childs.length;i++){childs[i].addEventListener('click',function(){var id=this.id.split('_')[1];if(id==that.zeroIndex){return;}
if(id==that.zeroIndex-1&&that.zeroIndex%that.column!=0){that.right();}else if(id==that.zeroIndex+1&&(that.zeroIndex+1)%that.column!=0){that.left();}else if(id==that.zeroIndex-that.column){that.down();}else if(id==that.zeroIndex+that.column){that.up();}
that.judgeSuc();});}},judgeAction:function(dx,dy){if(Math.abs(dx)>Math.abs(dy)){if(dx<-2){this.left();}else if(dx>2){this.right();}}else{if(dy<-2){this.up();}else if(dy>2){this.down();}}
this.judgeSuc();},judgeSuc:function(){if(this.needJudgeSuc&&this.initArr.toString()==this.arr.toString()){this.mainEle.querySelector('#item_'+this.zeroIndex).style.opacity=1;var that=this;setTimeout(function(){that.mainEle.outerHTML=that.mainEle.outerHTML;},500);if(this.sucRemove){this.imgElement.style.display='';this.remove();}
if('function'==typeof this.success)
this.success(this.imgElement);}},remove:function(){this.mainEle.parentNode.removeChild(this.mainEle);},right:function(){if(this.zeroIndex%this.column==0){return false;}
var eleIndex=this.zeroIndex-1;var ele=this.mainEle.querySelector('#item_'+eleIndex);var zeroEle=this.mainEle.querySelector('#item_'+this.zeroIndex);var temp=ele.style.left;temp=parseInt(temp.substring(0,temp.length-2));ele.style.left=(temp+this.unitW)+'px';var tempz=zeroEle.style.left;tempz=parseInt(tempz.substring(0,tempz.length-2));zeroEle.style.left=(tempz-this.unitW)+'px';zeroEle.id='item_'+eleIndex;ele.id='item_'+this.zeroIndex;this.arr[this.zeroIndex]=this.arr[eleIndex];this.arr[--this.zeroIndex]=0;return true;},left:function(){if((this.zeroIndex+1)%this.column==0){return false;}
var eleIndex=this.zeroIndex+1;var ele=this.mainEle.querySelector('#item_'+eleIndex);var zeroEle=this.mainEle.querySelector('#item_'+this.zeroIndex);var temp=ele.style.left;temp=parseInt(temp.substring(0,temp.length-2));ele.style.left=(temp-this.unitW)+'px';var tempz=zeroEle.style.left;tempz=parseInt(tempz.substring(0,tempz.length-2));zeroEle.style.left=(tempz+this.unitW)+'px';zeroEle.id='item_'+eleIndex;ele.id='item_'+this.zeroIndex;this.arr[this.zeroIndex]=this.arr[this.zeroIndex+1];this.arr[++this.zeroIndex]=0;return true;},down:function(){if(this.zeroIndex<this.column){return false;}
var eleIndex=this.zeroIndex-this.column;var ele=this.mainEle.querySelector('#item_'+eleIndex);var zeroEle=this.mainEle.querySelector('#item_'+this.zeroIndex);var temp=ele.style.top;temp=parseInt(temp.substring(0,temp.length-2));ele.style.top=(temp+this.unitH)+'px';var tempz=zeroEle.style.top;tempz=parseInt(tempz.substring(0,tempz.length-2));zeroEle.style.top=(tempz-this.unitH)+'px';zeroEle.id='item_'+eleIndex;ele.id='item_'+this.zeroIndex;this.arr[this.zeroIndex]=this.arr[this.zeroIndex-this.column];this.arr[this.zeroIndex-this.column]=0;this.zeroIndex=this.zeroIndex-this.column;return true;},up:function(){if(this.zeroIndex>=this.column*(this.row-1)){return false;}
var eleIndex=this.zeroIndex+this.column;var ele=this.mainEle.querySelector('#item_'+eleIndex);var zeroEle=this.mainEle.querySelector('#item_'+this.zeroIndex);var temp=ele.style.top;temp=parseInt(temp.substring(0,temp.length-2));ele.style.top=(temp-this.unitH)+'px';var tempz=zeroEle.style.top;tempz=parseInt(tempz.substring(0,tempz.length-2));zeroEle.style.top=(tempz+this.unitH)+'px';zeroEle.id='item_'+eleIndex;ele.id='item_'+this.zeroIndex;this.arr[this.zeroIndex]=this.arr[this.zeroIndex+this.column];this.arr[this.zeroIndex+this.column]=0;this.zeroIndex=this.zeroIndex+this.column;return true;}};return Tulip;})();